name: Build Windows Release

on:
    push:
        branches: ["main", "master"]

jobs:
    build-windows:
        runs-on: windows-latest

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install libheif via vcpkg
              run: |
                  vcpkg install libheif:x64-windows-static
                  vcpkg integrate install

            - name: Build Release
              shell: pwsh
              run: |
                  # Dynamically find the vcpkg installation path
                  $vcpkgPath = $env:VCPKG_INSTALLATION_ROOT
                  $libPath = "$vcpkgPath\installed\x64-windows-static\lib"

                  # Set environment variables for the cargo process
                  $env:LIBHEIF_PATH = "$vcpkgPath\installed\x64-windows-static"
                  $env:VCPKG_ROOT = $vcpkgPath
                  $env:RUSTFLAGS = "-L native=$libPath"

                  cargo build --release

            - name: Upload Executable
              uses: actions/upload-artifact@v4
              with:
                  name: ImgViewer-Windows
                  path: target/release/ImgViewer.exe
